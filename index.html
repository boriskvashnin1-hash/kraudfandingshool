<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∫–æ–ª—å–Ω—ã–π –ö—Ä–∞—É–¥—Ñ–∞–Ω–¥–∏–Ω–≥</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä—è–º–æ –≤ HTML */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input, textarea, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        .projects { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì –®–∫–æ–ª—å–Ω—ã–π –ö—Ä–∞—É–¥—Ñ–∞–Ω–¥–∏–Ω–≥</h1>
        <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —à–∫–æ–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
        
        <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div id="authSection" class="card">
            <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="email" id="email" placeholder="–í–∞—à email" value="test@school.ru">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="123456">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <button onclick="signup()" style="background:#2196F3">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
        
        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ (—Å–∫—Ä—ã—Ç–æ –¥–æ –≤—Ö–æ–¥–∞) -->
        <div id="createProjectSection" class="card" style="display:none">
            <h2>üìù –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h2>
            <input type="text" id="projectTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
            <textarea id="projectDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" rows="3"></textarea>
            <input type="number" id="projectGoal" placeholder="–¶–µ–ª—å (—Ä—É–±.)">
            <button onclick="createProject()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </div>
        
        <!-- –ü—Ä–æ–µ–∫—Ç—ã -->
        <div id="projectsSection">
            <h2>üöÄ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h2>
            <div id="projects" class="projects"></div>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="adminPanel" class="card" style="display:none">
            <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
            <button onclick="showUsers()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
            <button onclick="deleteAllProjects()" style="background:#ff4444">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã (–∞–¥–º–∏–Ω)</button>
        </div>
        
        <!-- –û—Ç–ª–∞–¥–∫–∞ -->
        <div class="card">
            <h3>üõ†Ô∏è –û—Ç–ª–∞–¥–∫–∞</h3>
            <button onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ</button>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script>
        // === –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ===
        // –ó–ê–ú–ï–ù–ò –≠–¢–ò –î–ê–ù–ù–´–ï –ù–ê –°–í–û–ò –ò–ó SUPABASE!
        const SUPABASE_URL = 'https://your-project.supabase.co';
        const SUPABASE_KEY = 'your-anon-key';
        
        // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;
        
        // === –ü–†–û–í–ï–†–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===
        async function testConnection() {
            const debug = document.getElementById('debugInfo');
            debug.innerHTML = '<p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>';
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ–º –ª–∏ –º—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                const { data, error } = await supabase
                    .from('projects')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                debug.innerHTML = '<p style="color:green">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ!</p>';
            } catch (error) {
                debug.innerHTML = `<p style="color:red">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>
                                   <p>1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ <a href="https://supabase.com" target="_blank">supabase.com</a></p>
                                   <p>2. –ó–∞–º–µ–Ω–∏ SUPABASE_URL –∏ SUPABASE_KEY –≤ –∫–æ–¥–µ</p>
                                   <p>3. –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É projects –≤ SQL Editor:</p>
                                   <pre>
CREATE TABLE projects (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    goal INTEGER,
    collected INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    user_id TEXT
);
                                   </pre>`;
            }
        }
        
        // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===
        async function signup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            });
            
            if (error) {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
            } else {
                alert('–£—Å–ø–µ—à–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                currentUser = data.user;
                updateUI();
            }
        }
        
        // === –í–•–û–î ===
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
            } else {
                alert('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!');
                currentUser = data.user;
                updateUI();
            }
        }
        
        // === –í–´–•–û–î ===
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            updateUI();
            alert('–í—ã –≤—ã—à–ª–∏');
        }
        
        // === –°–û–ó–î–ê–ù–ò–ï –ü–†–û–ï–ö–¢–ê ===
        async function createProject() {
            if (!currentUser) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
                return;
            }
            
            const project = {
                title: document.getElementById('projectTitle').value,
                description: document.getElementById('projectDescription').value,
                goal: parseInt(document.getElementById('projectGoal').value),
                user_id: currentUser.id
            };
            
            const { data, error } = await supabase
                .from('projects')
                .insert([project]);
            
            if (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } else {
                alert('–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!');
                document.getElementById('projectTitle').value = '';
                document.getElementById('projectDescription').value = '';
                document.getElementById('projectGoal').value = '';
                loadProjects();
            }
        }
        
        // === –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–ï–ö–¢–û–í ===
        async function loadProjects() {
            const { data: projects, error } = await supabase
                .from('projects')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                return;
            }
            
            const container = document.getElementById('projects');
            container.innerHTML = '';
            
            projects.forEach(project => {
                const progress = project.goal > 0 ? Math.round((project.collected / project.goal) * 100) : 0;
                
                const projectHTML = `
                    <div class="card">
                        <h3>${project.title}</h3>
                        <p>${project.description}</p>
                        <p><strong>–¶–µ–ª—å:</strong> ${project.goal} —Ä—É–±.</p>
                        <p><strong>–°–æ–±—Ä–∞–Ω–æ:</strong> ${project.collected} —Ä—É–±. (${progress}%)</p>
                        <div style="height: 10px; background: #eee; margin: 10px 0;">
                            <div style="height: 100%; width: ${Math.min(progress, 100)}%; background: #4CAF50;"></div>
                        </div>
                        <button onclick="donate(${project.id})">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å</button>
                        <button onclick="deleteProject(${project.id})" style="background: #ff4444; margin-top:5px">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                
                container.innerHTML += projectHTML;
            });
        }
        
        // === –ü–û–î–î–ï–†–ñ–ê–¢–¨ –ü–†–û–ï–ö–¢ ===
        async function donate(projectId) {
            const amount = prompt('–°–∫–æ–ª—å–∫–æ —Ä—É–±–ª–µ–π —Ö–æ—Ç–∏—Ç–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å?');
            if (!amount || isNaN(amount)) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—É–º–º—É
            const { data: project } = await supabase
                .from('projects')
                .select('collected')
                .eq('id', projectId)
                .single();
            
            const newAmount = (project.collected || 0) + parseInt(amount);
            
            await supabase
                .from('projects')
                .update({ collected: newAmount })
                .eq('id', projectId);
            
            alert('–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É!');
            loadProjects();
        }
        
        // === –£–î–ê–õ–ò–¢–¨ –ü–†–û–ï–ö–¢ ===
        async function deleteProject(projectId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?')) return;
            
            await supabase
                .from('projects')
                .delete()
                .eq('id', projectId);
            
            loadProjects();
        }
        
        // === –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò ===
        async function showUsers() {
            const { data: users, error } = await supabase.auth.admin.listUsers();
            
            if (error) {
                alert('–¢—Ä–µ–±—É–µ—Ç—Å—è Service Role Key –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Supabase');
                return;
            }
            
            alert(`–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.users.length}`);
        }
        
        async function deleteAllProjects() {
            if (!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –í–°–ï –ø—Ä–æ–µ–∫—Ç—ã?')) return;
            
            await supabase
                .from('projects')
                .delete()
                .neq('id', 0); // –£–¥–∞–ª—è–µ–º –≤—Å–µ
            
            loadProjects();
        }
        
        // === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ===
        function updateUI() {
            const authSection = document.getElementById('authSection');
            const createSection = document.getElementById('createProjectSection');
            const adminPanel = document.getElementById('adminPanel');
            
            if (currentUser) {
                authSection.innerHTML = `
                    <h2>üëã –ü—Ä–∏–≤–µ—Ç, ${currentUser.email}!</h2>
                    <button onclick="logout()">–í—ã–π—Ç–∏</button>
                `;
                createSection.style.display = 'block';
                adminPanel.style.display = 'block';
            } else {
                authSection.innerHTML = `
                    <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                    <input type="email" id="email" placeholder="–í–∞—à email" value="test@school.ru">
                    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="123456">
                    <button onclick="login()">–í–æ–π—Ç–∏</button>
                    <button onclick="signup()" style="background:#2196F3">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                `;
                createSection.style.display = 'none';
                adminPanel.style.display = 'none';
            }
            
            loadProjects();
        }
        
        // === –ü–†–û–í–ï–†–ö–ê –¢–ï–ö–£–©–ï–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===
        async function checkUser() {
            const { data } = await supabase.auth.getUser();
            currentUser = data.user;
            updateUI();
        }
        
        // === –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ===
        document.addEventListener('DOMContentLoaded', function() {
            checkUser();
            loadProjects();
        });
    </script>
</body>
</html>
